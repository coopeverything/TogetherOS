{
  "version": "1.0.0",
  "errors": [],
  "resolved_patterns": [
    {
      "id": "err-008",
      "signature": {
        "type": "ux-process",
        "code": "INCOMPLETE_THEME_IMPLEMENTATION",
        "pattern": "CSS variables defined but components not updated to use design system classes"
      },
      "trigger": "user-reported",
      "occurrences": [
        {
          "session_date": "2025-12-05",
          "context": "Created sage-earth theme in globals.css, mapped to Tailwind config, but forum components still used hardcoded classes (bg-orange-600, bg-white). User saw only body background change."
        }
      ],
      "resolution": "Added Theme Implementation Protocol to togetheros-kb.md. Checklist: 1) Define CSS vars, 2) Map to Tailwind, 3) IDENTIFY affected components, 4) UPDATE EACH component to use design system classes, 5) TEST with toggle.",
      "kb_file_updated": ".claude/knowledge/togetheros-kb.md",
      "resolved_date": "2025-12-05T16:15:00Z",
      "source": "https://css-tricks.com/color-theming-with-css-custom-properties-and-tailwind/"
    },
    {
      "signature": {
        "type": "runtime",
        "code": "MISSING_EXPORT",
        "pattern": "Function imported but not exported from module"
      },
      "resolution": "Added getCurrentUser function to middleware.ts. Added API route pre-flight check to KB.",
      "kb_file_updated": ".claude/knowledge/togetheros-kb.md",
      "resolved_date": "2025-12-04T03:00:00Z",
      "details": {
        "affected_files": [
          "apps/web/app/api/admin/support-points/route.ts",
          "apps/web/app/api/admin/reward-points/route.ts",
          "apps/web/app/api/admin/badges/route.ts"
        ],
        "missing_export": "getCurrentUser",
        "source_module": "@/lib/auth/middleware"
      }
    },
    {
      "signature": {
        "type": "runtime",
        "code": "MODULE_NOT_FOUND",
        "pattern": "Import from non-existent module file"
      },
      "resolution": "Created lib/db/badges.ts with required helper functions. Added module existence check to KB.",
      "kb_file_updated": ".claude/knowledge/togetheros-kb.md",
      "resolved_date": "2025-12-04T03:00:00Z",
      "details": {
        "affected_files": [
          "apps/web/app/api/admin/badges/route.ts"
        ],
        "missing_module": "@/lib/db/badges",
        "missing_exports": ["getBadgeStats", "getRecentBadgeAwards"]
      },
      "source": "https://www.applause.com/blog/bug-fix-verification-speed-up-development/"
    },
    {
      "id": "err-006",
      "signature": {
        "type": "process",
        "code": "INCOMPLETE_BRANCH_ANALYSIS",
        "pattern": "Analyzed only PRs when asked about branches AND PRs, missed squash-merged branches"
      },
      "occurrences": [
        {
          "session_date": "2025-12-04",
          "commit_sha": null,
          "file": null,
          "message": "User asked to check 'which branches and PRs are safe to merge'. Only checked open PRs, missed feature/onboarding-mystery-unlock which had commits ahead but was already squash-merged via PR #361.",
          "context": "Branch appeared in 'git branch --no-merged' output but was actually merged via squash. Should have cross-referenced with gh pr list --state all."
        }
      ],
      "resolution": "Added 'Branch/PR Merge Analysis Protocol' section to ci-cd-discipline.md. Solution: Always cross-reference 'not merged' branches with PR status using `gh pr list --head <branch> --state all` to detect squash-merged branches.",
      "kb_file_updated": ".claude/knowledge/ci-cd-discipline.md",
      "resolved_date": "2025-12-04T02:50:00Z",
      "source": "https://stackoverflow.com/questions/19308790/git-branch-merged-no-merged-and-squash-option"
    },
    {
      "id": "err-007",
      "signature": {
        "type": "config",
        "code": "SKILL_NOT_REGISTERED",
        "pattern": "Skill exists in .claude/skills/ but not in settings.local.json permissions"
      },
      "occurrences": [
        {
          "session_date": "2025-12-04",
          "commit_sha": null,
          "file": ".claude/skills/error-learner/SKILL.md",
          "message": "Skill(error-learner) invocation failed - skill exists but wasn't registered in settings.local.json allow list",
          "context": "User asked to use error-learner skill. Skill tool returned 'Unknown skill'. Had to manually read SKILL.md and execute steps."
        }
      ],
      "resolution": "Added Skill(error-learner) and Skill(ux-designer) to .claude/settings.local.json permissions allow list. Note: settings.local.json is gitignored (local config per machine).",
      "kb_file_updated": ".claude/settings.local.json (local, not tracked)",
      "resolved_date": "2025-12-04T03:15:00Z",
      "source": null
    },
    {
      "id": "err-009",
      "signature": {
        "type": "deployment",
        "code": "PM2_RESTART_LOOP_CPU_OVERLOAD",
        "pattern": "PM2 unlimited restarts during build causes CPU throttling on VPS"
      },
      "trigger": "user-reported",
      "occurrences": [
        {
          "session_date": "2025-12-11",
          "context": "Deployment triggered PM2 restart while build was incomplete. PM2 restarted app 441 times in rapid succession (no restart limits configured). Hostinger VPS hit CPU limit and throttled server. Health checks failed, rollback failed, site went down. Required manual server reboot."
        }
      ],
      "resolution": "Two fixes applied: 1) Deployment workflow now stops PM2 BEFORE deleting .next and building, then starts PM2 AFTER build completes with BUILD_ID verification. 2) ecosystem.config.js now includes restart limits: max_restarts=10, min_uptime=10s, restart_delay=4000ms, exp_backoff_restart_delay=100ms.",
      "kb_file_updated": ".github/workflows/auto-deploy-production.yml, ecosystem.config.js",
      "resolved_date": "2025-12-11T16:40:00Z",
      "details": {
        "root_cause": "Race condition: PM2 running while .next deleted and rebuilt. PM2 default behavior is unlimited instant restarts.",
        "symptoms": ["Cannot find module 'tailwind-merge'", "Missing Next.js chunks", "BUILD_ID not found", "441 restarts in PM2 logs"],
        "affected_systems": ["Hostinger VPS CPU limits", "Production site availability"]
      },
      "source": "https://pm2.keymetrics.io/docs/usage/restart-strategies/"
    },
    {
      "id": "err-010",
      "signature": {
        "type": "security",
        "code": "SUSPICIOUS_CRONTAB_ENTRIES",
        "pattern": "Crontab entries attempting to hide processes from /proc"
      },
      "trigger": "discovered-during-investigation",
      "occurrences": [
        {
          "session_date": "2025-12-11",
          "context": "While investigating PM2 restart loop, found 3 suspicious crontab entries running every minute. Entries attempted to mount empty directory over /proc/$pid to hide meshagent process. Entries were broken (missing || operator, /tmp/empty didn't exist) so never actually worked."
        }
      ],
      "resolution": "Removed suspicious entries from root crontab. meshagent is Hostinger's legitimate MeshCentral management tool. Entries were likely failed automated malware attempt. Added periodic crontab audit to security checklist.",
      "kb_file_updated": ".claude/knowledge/togetheros-kb.md",
      "resolved_date": "2025-12-11T17:45:00Z",
      "details": {
        "malicious_pattern": "* * * * * pgrep -f meshagent | while read pid; do mountpoint -q /proc/$pid || mount -o bind /tmp/empty /proc/$pid 2>/dev/null; done",
        "legitimate_process": "meshagent (Hostinger MeshCentral remote management)",
        "attack_success": false,
        "probability_assessment": "LOW (~20-30%)",
        "entries_removed": 3
      },
      "source": null
    },
    {
      "id": "err-011",
      "signature": {
        "type": "architectural-reasoning",
        "code": "RESTRUCTURE_WITHOUT_DEPENDENCY_ANALYSIS",
        "pattern": "Restructuring files/paths/aliases without first mapping the full import dependency graph"
      },
      "trigger": "user-reported",
      "occurrences": [
        {
          "session_date": "2025-12-12",
          "commit_sha": "9651985",
          "context": "Session 1: Saw @/lib/bridge/content-indexer imports failing. Changed @/lib/* to point to ./lib/* (web lib). This broke rate-limiter, logger, docs-indexer imports which expected root lib. Reverted, used ugly relative paths. Never considered adding second alias."
        },
        {
          "session_date": "2025-12-12",
          "commit_sha": null,
          "context": "Session 2 (this session): Saw two lib directories with bridge folders. Instinct said 'consolidate to one location.' Started moving rate-limiter, logger, docs-indexer FROM root lib TO web lib. Would have broken all @/lib/bridge/* imports. Had to reverse changes and adopt two-alias approach instead."
        }
      ],
      "root_cause_analysis": {
        "surface_symptom": "Import paths failing OR duplicate directory structures",
        "instinctive_response": "Change the path alias OR consolidate everything to one place",
        "fundamental_error": "Acting on instinct without analyzing full dependency graph",
        "why_it_fails": "Different consumers depend on different path resolutions. Changing one path breaks other consumers. Single-alias cannot serve multiple targets.",
        "cognitive_bias": "Consolidation bias - assumption that fewer directories = cleaner architecture. False when different consumers have different needs."
      },
      "resolution": "Added 'Path Alias & File Restructuring Protocol' to togetheros-kb.md. MANDATORY: Before ANY file moves or path alias changes, must run dependency analysis grep to map all consumers. Solution for split dependencies: Use multiple aliases (@/lib/* for shared, @web/* for app-specific) rather than forcing everything into one location.",
      "kb_file_updated": ".claude/knowledge/togetheros-kb.md",
      "resolved_date": "2025-12-12T18:45:00Z",
      "details": {
        "affected_files": [
          "apps/web/tsconfig.json",
          "apps/web/app/api/bridge/ask/route.ts",
          "apps/web/app/api/forum/topics/route.ts",
          "apps/web/app/api/proposals/route.ts",
          "lib/bridge/rate-limiter.ts",
          "lib/bridge/logger.ts",
          "lib/bridge/docs-indexer.ts",
          "apps/web/lib/bridge/content-indexer.ts"
        ],
        "correct_solution": {
          "approach": "Two aliases serving different purposes",
          "shared_alias": "@/lib/* → ../../lib/* (rate-limiter, logger, docs-indexer)",
          "app_alias": "@web/* → ./lib/* (content-indexer, context-service, etc.)"
        },
        "wrong_approaches_attempted": [
          "Toggle single @/lib/* alias between root lib and web lib",
          "Consolidate all files to web lib (would break @/lib/bridge/* imports)",
          "Use ugly relative paths like ../../../../../lib/bridge/*"
        ]
      },
      "sources": [
        "https://martinfowler.com/articles/refactoring-dependencies.html",
        "https://nx.dev/blog/managing-ts-packages-in-monorepos",
        "https://www.codesee.io/learning-center/code-refactoring"
      ]
    },
    {
      "id": "err-012",
      "signature": {
        "type": "sql-schema",
        "code": "TABLE_NAME_ASSUMPTION",
        "pattern": "Assumed table name based on entity name without verifying actual schema"
      },
      "trigger": "session-repetitive",
      "occurrences": [
        {
          "session_date": "2025-12-13",
          "commit_sha": null,
          "file": "packages/db/src/unified-knowledge.ts",
          "message": "ERROR: relation \"forum_topics\" does not exist",
          "context": "Writing Bridge search queries. Assumed table name 'forum_topics' because we were querying forum topics. Actual table name is 'topics' (no module prefix for legacy reasons)."
        }
      ],
      "resolution": "Added SQL Schema Verification Protocol to togetheros-kb.md. MANDATORY: Run `\\dt *pattern*` to verify table names before writing queries.",
      "kb_file_updated": ".claude/knowledge/togetheros-kb.md",
      "resolved_date": "2025-12-13T15:40:00Z",
      "details": {
        "affected_files": [
          "packages/db/src/unified-knowledge.ts",
          "packages/db/src/bridge-content-fetch.ts",
          "packages/db/src/bridge-indexer.ts",
          "scripts/backfill-bridge-content-index.ts"
        ],
        "wrong_name": "forum_topics",
        "correct_name": "topics"
      },
      "sources": [
        "https://www.mydbops.com/blog/postgresql-schema-guide",
        "https://climbtheladder.com/10-postgresql-schema-best-practices/"
      ]
    },
    {
      "id": "err-013",
      "signature": {
        "type": "sql-schema",
        "code": "TABLE_STRUCTURE_ASSUMPTION",
        "pattern": "Assumed separate tables per entity subtype when unified table with discriminator exists"
      },
      "trigger": "session-repetitive",
      "occurrences": [
        {
          "session_date": "2025-12-13",
          "commit_sha": null,
          "file": "packages/db/src/bridge-content-fetch.ts",
          "message": "ERROR: relation \"forum_topic_reactions\" does not exist",
          "context": "Assumed separate reaction tables for topics, posts, and replies (forum_topic_reactions, forum_post_reactions, forum_reply_reactions). Actual structure: single 'forum_reactions' table with 'content_type' discriminator column."
        }
      ],
      "resolution": "Added to SQL Schema Verification Protocol: Check for discriminator columns (content_type, target_type) that indicate unified table design.",
      "kb_file_updated": ".claude/knowledge/togetheros-kb.md",
      "resolved_date": "2025-12-13T15:40:00Z",
      "details": {
        "affected_files": [
          "packages/db/src/bridge-content-fetch.ts",
          "packages/db/src/bridge-indexer.ts"
        ],
        "wrong_names": ["forum_topic_reactions", "forum_post_reactions", "forum_reply_reactions"],
        "correct_pattern": "forum_reactions WHERE content_type = 'post' | 'reply'"
      }
    },
    {
      "id": "err-014",
      "signature": {
        "type": "sql-type",
        "code": "UUID_TEXT_COMPARISON",
        "pattern": "Comparing UUID column to TEXT value with ::text cast"
      },
      "trigger": "session-repetitive",
      "occurrences": [
        {
          "session_date": "2025-12-13",
          "commit_sha": null,
          "file": "packages/db/src/unified-knowledge.ts",
          "message": "ERROR: operator does not exist: uuid = text (position 413)",
          "context": "support_points_allocations.target_id is UUID type. Queries used 'target_id = t.id::text' attempting to compare UUID to TEXT. Also had issue with ILIKE ANY($2) needing $2::TEXT[] cast."
        }
      ],
      "resolution": "Added to SQL Schema Verification Protocol: Verify column types before comparisons. UUID columns should compare to UUID, not TEXT.",
      "kb_file_updated": ".claude/knowledge/togetheros-kb.md",
      "resolved_date": "2025-12-13T15:40:00Z",
      "details": {
        "affected_files": [
          "packages/db/src/unified-knowledge.ts",
          "packages/db/src/bridge-content-fetch.ts",
          "packages/db/src/bridge-indexer.ts"
        ],
        "wrong_pattern": "target_id = t.id::text",
        "correct_pattern": "target_id = t.id"
      }
    },
    {
      "id": "err-016",
      "signature": {
        "type": "validation",
        "code": "TRIM_MISMATCH",
        "pattern": "Frontend validation uses trim() but submission sends untrimmed value"
      },
      "trigger": "user-reported",
      "occurrences": [
        {
          "session_date": "2025-12-22",
          "commit_sha": null,
          "file": "packages/ui/src/feed/PostComposerUnified.tsx",
          "message": "User reports 'validation error' when creating post despite following input hints",
          "context": "Frontend validation checked title.trim().length < 10 but submission sent title || undefined (untrimmed). Whitespace-only input '   ' passed frontend (trim() is empty/falsy) but failed backend min(10) check."
        }
      ],
      "resolution": "Changed submission from 'title || undefined' to 'title.trim() || undefined'. Also trimmed content. Added err-016 to error-learnings.md with Pre-flight Checklist for form submissions.",
      "kb_file_updated": ".claude/knowledge/error-learnings.md",
      "resolved_date": "2025-12-22T19:50:00Z",
      "details": {
        "affected_files": [
          "packages/ui/src/feed/PostComposerUnified.tsx"
        ],
        "wrong_pattern": "if (title.trim().length < 10) { check } + onSubmit({ title: title || undefined })",
        "correct_pattern": "onSubmit({ title: title.trim() || undefined, content: content.trim() })"
      },
      "sources": [
        "https://github.com/react-hook-form/react-hook-form/issues/1650",
        "https://github.com/final-form/final-form/issues/242",
        "https://github.com/FusionAuth/fusionauth-issues/issues/1779"
      ]
    },
    {
      "id": "err-017",
      "signature": {
        "type": "validation",
        "code": "MULTI_LAYER_VALIDATION",
        "pattern": "Fixed validation in one layer but validation exists independently in multiple layers"
      },
      "trigger": "user-reported",
      "occurrences": [
        {
          "session_date": "2025-12-22",
          "commit_sha": null,
          "file": "packages/validators/src/groups.ts",
          "message": "Fixed Zod validators to allow slug-based groupId but handlers still had inline UUID regex validation",
          "context": "Groups UUID error persisted after fixing Zod schema because handlers/crud.ts had independent UUID validation. Required 4 cascading fixes over 3 hours: validators, handlers, fixtures, frontend API fetch."
        }
      ],
      "root_cause_analysis": {
        "surface_symptom": "Validation error persists after fixing the obvious validator",
        "instinctive_response": "Fix the Zod schema and claim success",
        "fundamental_error": "Validation exists at multiple independent layers that don't share code",
        "layers_involved": [
          "packages/validators/ (Zod schemas)",
          "apps/api/src/modules/*/handlers/ (inline validation)",
          "apps/web/app/api/ (API route validation)",
          "React components (frontend validation)"
        ]
      },
      "resolution": "Added MANDATORY Fix Verification Checklist to CLAUDE.md. Before fixing validation errors: 1) grep for EXACT error message to find ALL layers, 2) Fix ALL locations found, 3) Run verify-fix.sh before claiming success.",
      "kb_file_updated": "CLAUDE.md, .claude/knowledge/error-learnings.md",
      "resolved_date": "2025-12-23T03:15:00Z",
      "details": {
        "affected_files": [
          "packages/validators/src/groups.ts",
          "apps/api/src/modules/groups/handlers/crud.ts",
          "apps/api/src/modules/groups/handlers/roles.ts",
          "apps/web/app/groups/page.tsx"
        ],
        "wrong_pattern": "Fix one validator, claim fixed, user tests, still broken, fix another layer, repeat",
        "correct_pattern": "grep -rn 'EXACT_ERROR_MESSAGE' apps/ packages/ && fix ALL locations found"
      },
      "sources": null
    }
  ],
  "last_updated": "2025-12-23T03:15:00Z"
}
