name: auto/deploy-production

# Automatically deploys changes from yolo branch to production VPS
# Triggers on: push to yolo (after all checks pass)

on:
  push:
    branches:
      - yolo
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
      - 'scripts/**'

  workflow_dispatch:
    inputs:
      force:
        description: 'Force deploy even if checks fail'
        required: false
        default: 'false'

permissions:
  contents: read

jobs:
  # Pre-deployment checks
  preflight:
    name: Pre-deployment checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Build TypeScript packages
        run: tsc --build

      - name: TypeScript check
        working-directory: apps/web
        run: npx tsc --noEmit

      - name: Build application
        working-directory: apps/web
        run: npm run build
        env:
          SKIP_ENV_VALIDATION: true

      - name: Preflight marker
        run: echo "PREFLIGHT=OK"

  # Deploy to production VPS
  deploy:
    name: Deploy to production
    needs: preflight
    runs-on: ubuntu-latest
    if: ${{ success() || github.event.inputs.force == 'true' }}
    environment:
      name: production
      url: https://coopeverything.org
    steps:
      - name: Configure SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.VPS_HOST }}
        run: |
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts

      - name: Deploy via SSH
        env:
          SSH_HOST: ${{ secrets.VPS_HOST }}
          SSH_USER: ${{ secrets.VPS_USER }}
        run: |
          set +e
          ssh -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} bash -s << 'ENDSSH'
            set -exuo pipefail
            echo "üöÄ Starting deployment..."

            cd /var/www/togetheros

            echo "‚Üí Pulling latest code from yolo..."
            git fetch origin yolo 2>&1
            git reset --hard origin/yolo 2>&1

            echo "‚Üí Running database migrations..."
            set +e
            # Load DATABASE_URL from .env for migrations
            export $(grep -v '^#' .env | grep DATABASE_URL | xargs)
            bash scripts/run-migrations.sh 2>&1
            MIGRATION_EXIT=$?
            set -e
            if [ $MIGRATION_EXIT -ne 0 ]; then
              echo "‚ö†Ô∏è  Migration failed (exit code: $MIGRATION_EXIT), continuing with deployment..."
              echo "Database may need manual intervention"
            fi

            echo "‚Üí Installing dependencies..."
            npm install --production=false 2>&1 | tail -20

            echo "‚Üí Building TypeScript packages..."
            npm run build:packages 2>&1 | tail -10

            echo "‚Üí Building application (site still running)..."
            cd apps/web

            # CRITICAL: Build WHILE site is still running
            # Old .next serves traffic, new build overwrites in place
            # PM2 stays up during build - only restart after success
            npm run build 2>&1 || {
              echo "‚ùå Build failed! Site still running on previous version."
              exit 1
            }

            # Verify build is complete
            if [ ! -f ".next/BUILD_ID" ]; then
              echo "‚ùå BUILD_ID not found - build incomplete!"
              exit 1
            fi
            echo "‚úì Build complete: $(cat .next/BUILD_ID)"

            # Only restart PM2 AFTER build succeeds (seconds of downtime, not minutes)
            echo "‚Üí Restarting PM2 to load new build..."
            cd /var/www/togetheros
            pm2 restart togetheros 2>&1 || pm2 start ecosystem.config.js 2>&1
            pm2 status togetheros 2>&1

            echo "‚úÖ Deployment complete!"
            echo "Visit: https://coopeverything.org"
          ENDSSH
          SSH_EXIT=$?
          set -e

          if [ $SSH_EXIT -ne 0 ]; then
            echo "::error::SSH deployment failed with exit code $SSH_EXIT"
            exit 1
          fi

      - name: Verify deployment health
        env:
          SSH_HOST: ${{ secrets.VPS_HOST }}
          SSH_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "‚è≥ Waiting for application to stabilize..."
          sleep 15

          echo "üîç Checking PM2 status..."
          PM2_STATUS=$(ssh -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} "pm2 status togetheros | grep togetheros | grep -c online" || echo "0")

          if [ "$PM2_STATUS" -eq "0" ]; then
            echo "‚ùå PM2 process not running, initiating rollback..."

            # Verify rollback target exists and is valid
            ROLLBACK_COMMIT=$(ssh -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} "cd /var/www/togetheros && git rev-parse HEAD~1 2>/dev/null || echo 'invalid'")
            if [ "$ROLLBACK_COMMIT" = "invalid" ]; then
              echo "::error::Cannot rollback - no previous commit available"
              exit 1
            fi
            echo "Rollback target: $ROLLBACK_COMMIT"

            ssh -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} "cd /var/www/togetheros && echo '‚Üí Rolling back to previous commit...' && git reset --hard HEAD~1 && npm run build:packages && cd apps/web && npm run build && pm2 restart togetheros"
            exit 1
          fi

          echo "üè• Checking /api/health endpoint..."
          HEALTH_STATUS=$(curl -sf https://coopeverything.org/api/health | jq -r '.status' || echo "error")

          if [ "$HEALTH_STATUS" != "ok" ] && [ "$HEALTH_STATUS" != "degraded" ]; then
            echo "‚ùå Health check failed (status: $HEALTH_STATUS), initiating rollback..."

            # Verify rollback target exists and is valid
            ROLLBACK_COMMIT=$(ssh -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} "cd /var/www/togetheros && git rev-parse HEAD~1 2>/dev/null || echo 'invalid'")
            if [ "$ROLLBACK_COMMIT" = "invalid" ]; then
              echo "::error::Cannot rollback - no previous commit available"
              exit 1
            fi
            echo "Rollback target: $ROLLBACK_COMMIT"

            ssh -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} "cd /var/www/togetheros && echo '‚Üí Rolling back to previous commit...' && git reset --hard HEAD~1 && npm run build:packages && cd apps/web && npm run build && pm2 restart togetheros && echo '‚Üí Rollback complete, waiting for recovery...' && sleep 10"

            # Verify rollback succeeded
            ROLLBACK_HEALTH=$(curl -sf https://coopeverything.org/api/health | jq -r '.status' || echo "error")
            if [ "$ROLLBACK_HEALTH" == "ok" ] || [ "$ROLLBACK_HEALTH" == "degraded" ]; then
              echo "‚úÖ Rollback successful, previous version restored"
            else
              echo "üö® CRITICAL: Rollback failed, manual intervention required"
            fi
            exit 1
          fi

          echo "üß™ Testing critical endpoints..."
          curl -f https://coopeverything.org/ || {
            echo "‚ùå Homepage failed, initiating rollback..."
            ROLLBACK_COMMIT=$(ssh -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} "cd /var/www/togetheros && git rev-parse HEAD~1 2>/dev/null || echo 'invalid'")
            if [ "$ROLLBACK_COMMIT" != "invalid" ]; then
              echo "Rollback target: $ROLLBACK_COMMIT"
              ssh -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} "cd /var/www/togetheros && git reset --hard HEAD~1 && npm run build:packages && cd apps/web && npm run build && pm2 restart togetheros"
            else
              echo "::error::Cannot rollback - no previous commit available"
            fi
            exit 1
          }

          curl -f https://coopeverything.org/signup || {
            echo "‚ùå Signup page failed, initiating rollback..."
            ROLLBACK_COMMIT=$(ssh -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} "cd /var/www/togetheros && git rev-parse HEAD~1 2>/dev/null || echo 'invalid'")
            if [ "$ROLLBACK_COMMIT" != "invalid" ]; then
              echo "Rollback target: $ROLLBACK_COMMIT"
              ssh -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} "cd /var/www/togetheros && git reset --hard HEAD~1 && npm run build:packages && cd apps/web && npm run build && pm2 restart togetheros"
            else
              echo "::error::Cannot rollback - no previous commit available"
            fi
            exit 1
          }

          echo "‚úÖ All health checks passed!"
          echo "HEALTH_STATUS=$HEALTH_STATUS"

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

      - name: Deployment marker
        run: echo "DEPLOY=OK"

  # Notify on completion
  notify:
    name: Notify deployment status
    needs: [preflight, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Deployment successful"
            echo "üåê Site: https://coopeverything.org"
          else
            echo "‚ùå Deployment failed"
            exit 1
          fi
