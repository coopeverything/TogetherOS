name: auto/deploy-production

# Automatically deploys changes from yolo branch to production VPS
# Triggers on: push to yolo (after all checks pass)

on:
  push:
    branches:
      - yolo
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
      - 'scripts/**'

  workflow_dispatch:
    inputs:
      force:
        description: 'Force deploy even if checks fail'
        required: false
        default: 'false'

permissions:
  contents: read

jobs:
  # Pre-deployment checks
  preflight:
    name: Pre-deployment checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript packages
        run: tsc --build

      - name: TypeScript check
        working-directory: apps/web
        run: npx tsc --noEmit

      - name: Build application
        working-directory: apps/web
        run: npm run build
        env:
          SKIP_ENV_VALIDATION: true

      - name: Preflight marker
        run: echo "PREFLIGHT=OK"

  # Deploy to production VPS
  deploy:
    name: Deploy to production
    needs: preflight
    runs-on: ubuntu-latest
    if: ${{ success() || github.event.inputs.force == 'true' }}
    environment:
      name: production
      url: https://coopeverything.org
    steps:
      - name: Configure SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.VPS_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts

      - name: Deploy via SSH
        env:
          SSH_HOST: ${{ secrets.VPS_HOST }}
          SSH_USER: ${{ secrets.VPS_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} << 'ENDSSH'
            set -e
            echo "ðŸš€ Starting deployment..."

            cd /var/www/togetheros

            echo "â†’ Pulling latest code from yolo..."
            git fetch origin yolo
            git reset --hard origin/yolo

            echo "â†’ Installing dependencies..."
            npm install --production=false

            echo "â†’ Building TypeScript packages..."
            npm run build:packages

            echo "â†’ Cleaning previous build..."
            cd apps/web
            rm -rf .next

            echo "â†’ Building application..."
            npm run build

            echo "â†’ Restarting PM2..."
            pm2 restart togetheros || pm2 start ecosystem.config.js

            echo "âœ… Deployment complete!"
            echo "Visit: https://coopeverything.org"
          ENDSSH

      - name: Verify deployment health
        env:
          SSH_HOST: ${{ secrets.VPS_HOST }}
          SSH_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "â³ Waiting for application to stabilize..."
          sleep 15

          echo "ðŸ” Checking PM2 status..."
          PM2_STATUS=$(ssh -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} "pm2 status togetheros | grep togetheros | grep -c online" || echo "0")

          if [ "$PM2_STATUS" -eq "0" ]; then
            echo "âŒ PM2 process not running, initiating rollback..."
            ssh -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} << 'ROLLBACK'
              cd /var/www/togetheros
              echo "â†’ Rolling back to previous commit..."
              git reset --hard HEAD~1
              npm run build:packages
              cd apps/web && npm run build
              pm2 restart togetheros
            ROLLBACK
            exit 1
          fi

          echo "ðŸ¥ Checking /api/health endpoint..."
          HEALTH_STATUS=$(curl -sf https://coopeverything.org/api/health | jq -r '.status' || echo "error")

          if [ "$HEALTH_STATUS" != "ok" ] && [ "$HEALTH_STATUS" != "degraded" ]; then
            echo "âŒ Health check failed (status: $HEALTH_STATUS), initiating rollback..."
            ssh -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} << 'ROLLBACK'
              cd /var/www/togetheros
              echo "â†’ Rolling back to previous commit..."
              git reset --hard HEAD~1
              npm run build:packages
              cd apps/web && npm run build
              pm2 restart togetheros
              echo "â†’ Rollback complete, waiting for recovery..."
              sleep 10
            ROLLBACK

            # Verify rollback succeeded
            ROLLBACK_HEALTH=$(curl -sf https://coopeverything.org/api/health | jq -r '.status' || echo "error")
            if [ "$ROLLBACK_HEALTH" == "ok" ] || [ "$ROLLBACK_HEALTH" == "degraded" ]; then
              echo "âœ… Rollback successful, previous version restored"
            else
              echo "ðŸš¨ CRITICAL: Rollback failed, manual intervention required"
            fi
            exit 1
          fi

          echo "ðŸ§ª Testing critical endpoints..."
          curl -f https://coopeverything.org/ || {
            echo "âŒ Homepage failed, initiating rollback..."
            ssh -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} << 'ROLLBACK'
              cd /var/www/togetheros
              git reset --hard HEAD~1
              npm run build:packages
              cd apps/web && npm run build
              pm2 restart togetheros
ROLLBACK
            exit 1
          }

          curl -f https://coopeverything.org/signup || {
            echo "âŒ Signup page failed, initiating rollback..."
            ssh -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} << 'ROLLBACK'
              cd /var/www/togetheros
              git reset --hard HEAD~1
              npm run build:packages
              cd apps/web && npm run build
              pm2 restart togetheros
ROLLBACK
            exit 1
          }

          echo "âœ… All health checks passed!"
          echo "HEALTH_STATUS=$HEALTH_STATUS"

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

      - name: Deployment marker
        run: echo "DEPLOY=OK"

  # Notify on completion
  notify:
    name: Notify deployment status
    needs: [preflight, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Deployment successful"
            echo "ðŸŒ Site: https://coopeverything.org"
          else
            echo "âŒ Deployment failed"
            exit 1
          fi
