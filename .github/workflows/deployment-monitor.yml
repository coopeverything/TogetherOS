name: deployment/monitor

# Monitors deployment failures and creates GitHub notifications
# Triggers after auto-deploy-production workflow completes

on:
  workflow_run:
    workflows: ["auto/deploy-production"]
    types:
      - completed

permissions:
  issues: write
  contents: read
  actions: read

jobs:
  notify-on-failure:
    name: Notify deployment failure
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Get deployment details
        id: details
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get workflow run details
          RUN_ID="${{ github.event.workflow_run.id }}"
          RUN_URL="${{ github.event.workflow_run.html_url }}"
          COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
          BRANCH="${{ github.event.workflow_run.head_branch }}"

          # Get commit message
          COMMIT_MSG=$(gh api repos/${{ github.repository }}/commits/${COMMIT_SHA} --jq '.commit.message' | head -1)

          # Get recent deployment history
          RECENT_FAILURES=$(gh run list --workflow=auto-deploy-production.yml --status=failure --limit 10 --json conclusion | jq 'length')

          # Check health endpoint
          HEALTH_STATUS=$(curl -sf https://coopeverything.org/api/health | jq -r '.status' || echo "unreachable")
          HEALTH_DB=$(curl -sf https://coopeverything.org/api/health | jq -r '.checks.database.status' || echo "unknown")

          # Check if there's already an open deployment issue
          EXISTING_ISSUE=$(gh issue list --label "deployment-failure" --state open --limit 1 --json number --jq '.[0].number // empty')

          echo "run_url=${RUN_URL}" >> $GITHUB_OUTPUT
          echo "commit_msg=${COMMIT_MSG}" >> $GITHUB_OUTPUT
          echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
          echo "recent_failures=${RECENT_FAILURES}" >> $GITHUB_OUTPUT
          echo "health_status=${HEALTH_STATUS}" >> $GITHUB_OUTPUT
          echo "health_db=${HEALTH_DB}" >> $GITHUB_OUTPUT
          echo "existing_issue=${EXISTING_ISSUE}" >> $GITHUB_OUTPUT

      - name: Create or update issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          EXISTING_ISSUE="${{ steps.details.outputs.existing_issue }}"
          RUN_URL="${{ steps.details.outputs.run_url }}"
          COMMIT_MSG="${{ steps.details.outputs.commit_msg }}"
          COMMIT_SHA="${{ steps.details.outputs.commit_sha }}"
          BRANCH="${{ steps.details.outputs.branch }}"
          RECENT_FAILURES="${{ steps.details.outputs.recent_failures }}"
          HEALTH_STATUS="${{ steps.details.outputs.health_status }}"
          HEALTH_DB="${{ steps.details.outputs.health_db }}"

          # Format timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          # Build issue body
          BODY=$(cat <<EOF
          ## Deployment Failed

          **Time:** ${TIMESTAMP}
          **Branch:** \`${BRANCH}\`
          **Commit:** \`${COMMIT_SHA}\`
          **Message:** ${COMMIT_MSG}

          ### Failure Details
          - **Workflow Run:** ${RUN_URL}
          - **Recent failures:** ${RECENT_FAILURES} in last 10 deployments
          - **Health endpoint:** \`${HEALTH_STATUS}\`
          - **Database status:** \`${HEALTH_DB}\`

          ### Quick Diagnostics

          \`\`\`bash
          # Check health endpoint
          curl https://coopeverything.org/api/health | jq

          # Check recent deployments
          gh run list --workflow=auto-deploy-production.yml --limit 5

          # SSH to VPS and check PM2
          ssh root@72.60.27.167 "pm2 status togetheros && pm2 logs togetheros --lines 50"
          \`\`\`

          ### Common Issues
          - **Database authentication:** Check DATABASE_URL in ecosystem.config.js
          - **Health check failing:** Check /api/health endpoint logic
          - **Build errors:** Review workflow logs for TypeScript/build failures
          - **PM2 not running:** May need manual restart on VPS

          ---

          **Auto-generated by deployment-monitor workflow**
          EOF
          )

          if [ -n "$EXISTING_ISSUE" ]; then
            # Update existing issue with a comment
            COMMENT=$(cat <<EOF
          ### New Failure Detected

          **Time:** ${TIMESTAMP}
          **Commit:** \`${COMMIT_SHA}\` - ${COMMIT_MSG}
          **Run:** ${RUN_URL}
          **Pattern:** ${RECENT_FAILURES} failures in last 10 deployments

          Current status: Health=\`${HEALTH_STATUS}\`, DB=\`${HEALTH_DB}\`
          EOF
          )
            gh issue comment "$EXISTING_ISSUE" --body "$COMMENT"
            echo "âœ… Updated existing issue #${EXISTING_ISSUE}"
          else
            # Create new issue
            ISSUE_NUM=$(gh issue create \
              --title "ðŸš¨ Deployment Failure: ${COMMIT_MSG:0:60}" \
              --body "$BODY" \
              --label "deployment-failure,priority:high" \
              --assignee coopeverything | grep -oP '\d+$')
            echo "âœ… Created new issue #${ISSUE_NUM}"
          fi

      - name: Check for consecutive failures
        if: steps.details.outputs.recent_failures >= 3
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RECENT_FAILURES="${{ steps.details.outputs.recent_failures }}"
          EXISTING_ISSUE="${{ steps.details.outputs.existing_issue }}"

          # Add critical label if 3+ consecutive failures
          if [ -n "$EXISTING_ISSUE" ]; then
            gh issue edit "$EXISTING_ISSUE" --add-label "critical"

            ALERT=$(cat <<EOF
          ### âš ï¸ CRITICAL: Multiple Consecutive Failures

          **${RECENT_FAILURES} failed deployments detected in last 10 attempts**

          This indicates a systemic issue blocking all deployments. Priority investigation needed.

          **Recommended actions:**
          1. Check health endpoint: https://coopeverything.org/api/health
          2. Review recent code changes for breaking changes
          3. Verify VPS infrastructure (database, PM2, disk space)
          4. Consider manual rollback if issue persists
          EOF
          )
            gh issue comment "$EXISTING_ISSUE" --body "$ALERT"
            echo "ðŸš¨ Escalated to CRITICAL - ${RECENT_FAILURES} consecutive failures"
          fi
